name: Provision Infrastructure
on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

env:
  ONEPASSWORD_VAULT: Azure-Infra-Secret
  ONEPASSWORD_ENV_ITEM: "neuralis-desk-infra"
  DEPLOYMENT_ENV: ${{ github.event.inputs.env }}

jobs:
  provision-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Sync azure credentials from 1Password
        id: load-azure-creds
        run: |
          ENV_REFERENCE="op://${{ env.ONEPASSWORD_VAULT }}/${{ env.ONEPASSWORD_ENV_ITEM }}.${{ env.DEPLOYMENT_ENV }}.azure/notesPlain"

          echo "Syncing azure credentials from 1Password"

          # Récupérer le fichier depuis 1Password
          op read "$ENV_REFERENCE" > .azure-env.temp

          # Parser et synchroniser chaque variable
          while IFS='=' read -r key value; do
            # Ignorer les lignes vides et les commentaires
            if [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # Nettoyer la clé (supprimer les espaces)
            key=$(echo "$key" | xargs)
            
            # Nettoyer la valeur (supprimer les guillemets si présents)
            value=$(echo "$value" | sed 's/^["'\'']//' | sed 's/["'\'']$//')
            
            echo "Syncing $key"

            echo "$key=$value" >> $GITHUB_OUTPUT

          done < .azure-env.temp

          # Nettoyer le fichier temporaire
          rm -f .azure-env.temp
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure (azd)
        run: |
          azd auth login `
            --client-id "${{ env.AZURE_CLIENT_ID }}" `
            --client-secret "${{ env.AZURE_CLIENT_SECRET }}" `
            --tenant-id "${{ env.AZURE_TENANT_ID }}"
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ steps.load-azure-creds.outputs.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ steps.load-azure-creds.outputs.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ steps.load-azure-creds.outputs.AZURE_TENANT_ID }}

      - name: Sync .env from 1Password
        id: load-secrets
        run: |
          ENV_REFERENCE="op://${{ env.ONEPASSWORD_VAULT }}/${{ env.ONEPASSWORD_ENV_ITEM }}.${{ env.DEPLOYMENT_ENV }}.provision/notesPlain"

          echo "Syncing .env file from 1Password to .env"
          echo "Key Vault: ${{ env.KEY_VAULT_NAME }}"

          # Récupérer le fichier .env depuis 1Password
          # Récupérer le fichier .env depuis 1Password
          op read "$ENV_REFERENCE" > .env.temp

          # Parser et synchroniser chaque variable
          while IFS='=' read -r key value; do
            # Ignorer les lignes vides et les commentaires
            if [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # Nettoyer la clé (supprimer les espaces)
            key=$(echo "$key" | xargs)
            
            # Nettoyer la valeur (supprimer les guillemets si présents)
            value=$(echo "$value" | sed 's/^["'\'']//' | sed 's/["'\'']$//')
            
            echo "Syncing $key -> $secret_name"

            echo "$key=$value" >> $GITHUB_OUTPUT

          done < .env.temp

          # Nettoyer le fichier temporaire
          rm -f .env.temp
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Azure Dev Provision
        run: azd provision --no-prompt
        env:
          AZURE_ENV_NAME: ${{ steps.load-secrets.outputs.AZURE_ENV_NAME }}
          AZURE_RESOURCE_TOKEN: ${{ steps.load-secrets.outputs.AZURE_RESOURCE_TOKEN }}
          AZURE_LOCATION: ${{ steps.load-secrets.outputs.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ steps.load-secrets.outputs.AZURE_SUBSCRIPTION_ID }}
          POSTGRESQL_ADMIN_PASSWORD: ${{ steps.load-secrets.outputs.POSTGRESQL_ADMIN_PASSWORD }}
          AZURE_AUTH_CLIENT_SECRET: ${{ steps.load-secrets.outputs.AZURE_AUTH_CLIENT_SECRET }}
          AZURE_AUTH_CLIENT_ID: ${{ steps.load-secrets.outputs.AZURE_AUTH_CLIENT_ID }}
